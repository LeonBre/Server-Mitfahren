<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">

  <title>Index</title>
  <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="SitePoint">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <link rel="stylesheet" href="css/master.css" media="screen" title="no title" charset="utf-8">

  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>

<body>
    <nav>
      <div class="nav-wrapper teal lighten-2">
        <a href="#" class="brand-logo">Mitfahren</a>
        <ul id="nav-mobile" class="right hide-on-med-and-down">
          <li><a href="sass.html">Sass</a></li>
          <li><a href="badges.html">Components</a></li>
          <li><a id="navbarLogin">Login</a></li>
        </ul>
      </div>
    </nav>


  <div class="container">
    <div class="searchForm">
    <div class="row">
      <div class="col s12">
        <div class="row">
          <div class="input-field col s6">
            <!-- Search input DESTINATION -->
            <i class="material-icons prefix">textsms</i>
            <input type="text" id="autocomplete-input-von" class="autocomplete">
            <label for="autocomplete-input-von">Von</label>
          </div>
          <div class="input-field col s6">
            <!-- Search input ARRIVAL -->
            <i class="material-icons prefix">textsms</i>
            <input type="text" id="autocomplete-input-nach" class="autocomplete">
            <label for="autocomplete-input-nach">Nach</label>
          </div>
          <div class="row">
          <div class="col s6 offset-s3">
            <!-- Search input DATE-->
            <input type="date" class="datepicker" id="datepicker-date">
            <label for="datepicker">Zeit</label>
          </div>
        </div>
        <div class="row">
          <div class="col s4 offset-s5">
            <!-- Submit Buttom -->
            <button class="btn-large waves-effect waves-light" id="button-sendInformation"
            type="submit" name="action">Best√§tigen
              <i class="material-icons right">send</i>
            </button>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>
</div>

  <div class="resultCards">
    <ul id="resultList">

  </ul>
</div>


<div id="loginModal" class="modal">
  <div class="modal-content loginContent">
          <h3 class="brand-logo teal-text">Einloggen</h3>
          <div class="row">
            <div class="input-field col s12">
              <input id="loginUsername" type="text" class="validate">
              <label for="username">Nutzername</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12">
              <input id="loginPassword" type="password" class="validate">
              <label for="password">Passwort</label>
            </div>
          </div>
          <div class="row">
            <div class="col m6">
              <button class="btn" id="loginButton"> Login
              </button>
            </div>
        </div>
  </div>
</div>

  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/js/materialize.min.js"></script>
  <script src="resources/CryptoJS/rollups/sha512.js"></script>
  <script src="resources/jquery-cookie/js.cookie.js"></script>
  <script type="text/javascript">
  var destinationURL = "http://localhost:8080"
  var driveUrl = "/home/leon/development/git/Server-Mitfahren/Server-Mitfahren/src/main/webapp/drive.html"
  var userUrl = "/home/leon/development/git/Server-Mitfahren/Server-Mitfahren/src/main/webapp/user.html"
  var nullPictureUsername = 'http://lorempixel.com/100/190/nature/10';
  var possibleCities = new Array();

  var $navbarLogin = $('#navbarLogin');
  var $loginButton = $('#loginButton');
  var $loginUsername = $('#loginUsername');
  var $loginPassword = $('#loginPassword');

  var isLoggedIn = false;
  var $navbarRight = $('#nav-mobile')

  var $destination = $('#autocomplete-input-von');
  var $arrival = $('#autocomplete-input-nach');
  var $date = $('#datepicker-date');

  var $resultList = $('#resultList');

    $(document).ready(function() {
      //Starts the datepicker.
      $('.datepicker').pickadate({
        selectMonths: true,
        selectYears: 2
      });

      //Checks if the user is already logged in.
      if(Cookies.get('username') != null && Cookies.get('password') != null){
        isLoggedIn = true;
      }

      //Gets the information for the autocomplete texts from the server.
      $.ajax({
        type: 'GET',
        url: destinationURL + '/Server-Mitfahren/apiv1/possibleCities',
        success: function(cities){
          console.log(cities)
          $.each(cities, function(i, city) {
            possibleCities[city.name] = city.pictureUrl;
          })
          $destination.autocomplete({
             data : possibleCities
           });
         $arrival.autocomplete({
            data : possibleCities
          });
        }
      });
    });

    //Navbar Login Code.
    $navbarLogin.on('click', function() {
      if(isLoggedIn == false){
        $('#loginModal').openModal();
      } else {
        logout()
      }
    })

    //Logs the user in.
    //First it gets the username, then it saves the password as an SHA512 //encripted String
    //Then it verifies the username, password compination on the server.
    $loginButton.on('click', function() {
      var username = $loginUsername.val()

      //Hash Password
      var hashWordArray = CryptoJS.SHA512($loginPassword.val());
      var base64HashString = hashWordArray.toString(CryptoJS.enc.Base64);

      //store Data
      var data = {
        username : username,
        password : base64HashString
      }
      data = JSON.stringify(data)

      //send Data
      $.ajax({
        type: 'POST',
        url: destinationURL + '/Server-Mitfahren/apiv1/authenticate',
        contentType: "application/json",
        data: data,
        success: function(response) {
          console.log("From Server: ", JSON.stringify(response))
          if(response.isAuthenticated == true){
            login(username, base64HashString, response.userId)
          } else{
            $loginUsername.val("");
            $loginPassword.val("");
            makeToast("Nutzername oder Password ist falsch.")
          }
        },
        error: function() {
          console.log("Error");
        }
      });
    })
    //Makes the Login of a user visible to the website.
    function login(username, password, userId) {
      Cookies.set('username', username);
      Cookies.set('password', password)
      isLoggedIn = true;
      $('#loginModal').closeModal();
      $navbarLogin.text('Logout');
      makeToast("Erfolgreich eingeloggt.")
      $navbarRight.append('<li><a id="navbarUsername" '
                          + 'onclick="window.location=\'' + userUrl + '?userId=' + userId +'\';">'
                          + username + '</a></li>')
    }


    //Makes the logout visible to the website.
    function logout(){
      Cookies.remove('username')
      Cookies.remove('password')
      isLoggedIn = false;
      $navbarLogin.text('Login');
      makeToast("Erfolgreich ausgeloggt.")
      $('#navbarUsername').remove()
    }

    $('#button-sendInformation').on('click', function() {
      var dateIsValid = ($date.val() != null) && ($date.val() != "");
      if(    $destination.val() != null
          && $arrival.val() != null
          && dateIsValid) {

        var information = {
          destination: $destination.val(),
          arrival: $arrival.val(),
          date: $date.val(),
        };

        information = JSON.stringify(information)
        console.log("To Server: " + JSON.stringify(information));

        $.ajax({
          type: 'POST',
          url: destinationURL + '/Server-Mitfahren/apiv1/possibleDrives',
          contentType: "application/json",
          data: information,
          success: function(possibleDrives) {
            console.log("From Server: ", JSON.stringify(possibleDrives))
            showPossibleDrives(possibleDrives)
          },
          error: function() {
            console.log("Error");
          }
        });
    }
    });

    function showPossibleDrives(possibleDrives){
      if(possibleDrives == null) {
        makeToast("Leider keine Fahrt gefunden.")
      } else {
      $resultList.empty()
      $.each(possibleDrives, function(i, drive) {
        $resultList.append(
          createPossibleDriveListString(drive)
        );
      })
      Materialize.showStaggeredList('#resultList')
    }
    }

    function createPossibleDriveListString(drive) {

      var userPictureUrl = (drive.userPictureUrl == null) ? nullPictureUsername : drive.userPictureUrl
      var userName = drive.username
      var driveDestination = drive.destination
      var driveArrival = drive.arrival
      var driveDate = drive.date
      var driveTime = drive.time
      var driveId = drive.driveId

      listItem = '<li><div class="card horizontal" '
                  + 'onclick="window.location=\'' + driveUrl + '?driveId=' + driveId +'\';">'
                    + '<div class="card-image">'
                      + '<div class="userpicture">'
                        + '<img src="' + userPictureUrl + '">'
                      + '</div>'
                      + '<h5>' + userName + '</h5>'
                    + '</div>'
                    + '<div class="card-stacked" >'
                      + '<div class="card-content">'
                        + '<p>' + driveDestination + '</p>'
                      + '</div>'
                      + '<div class="card-content">'
                        + '<p>' + driveArrival + '</p>'
                      + '</div>'
                      + '<div class="card-content">'
                        + '<p>' + driveDate + '<p>'
                      + '</div>'
                    + '</div>'
                    + '<div class="card-content">'
                      + '<p>' + driveTime + '</p>'
                    + '</div>'
                  + '</div></li>'
      return listItem
    }

    function makeToast(toast) {
      Materialize.toast(toast, 3000, 'rounded')
    }

    //Cookie Plugin from :
    //https://github.com/js-cookie/js-cookie
  </script>
</body>

</html>
